---
title: "Projeto Crime Rio"
author: "Gabriela Alves"
date: "14/07/2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Criminalidade no Rio de Janeiro
Este estudo tem como objetivo criar um ranking com base em dados sobre a 
criminalidade do Estado do Rio de Janeiro. 
A proposta de criação deste ranking se dá por meio da Análise Fatorial por 
Componentes Principais, uma técnica não supervisionada de machine learning que
utiliza variáveis quantitativas para criar fatores que são responsáveis por 
capturar a variância compartilhada entre as variáveis e estes fatores são
ortogonais entre si.
Esta base de dados contém 53 variáveis quantitativas e pode ser encontrada no 
[link](https://www.ispdados.rj.gov.br:4432/estatistica.html). 


``` {r pacote, echo = FALSE, warning = FALSE,message = FALSE}

pacotes <- c("tidyverse","knitr","kableExtra","car","rgl","gridExtra",
             "PerformanceAnalytics","reshape2","rayshader","psych","pracma",
             "polynom","rqPen","ggrepel", "plotly","factoextra")

if(sum(as.numeric(!pacotes %in% installed.packages())) != 0){
  instalador <- pacotes[!pacotes %in% installed.packages()]
  for(i in 1:length(instalador)) {
    install.packages(instalador, dependencies = T)
    break()}
  sapply(pacotes, require, character = T)  
} else {
  sapply(pacotes, require, character = T) 
}

````
## Análise fatorial por componentes principais
A análise fatorial é uma técnica de aprendizado de máquina não supervisionada.
É uma técnica multivariada que utiliza apenas variáveis quantitativas/métricas
e essas variáveis tem um coeficiente de correlação alto entre si. 
O objetivo da análise fatorial é a extração de fatores a partir de uma matriz de
correlação gerada  dessas variáveis (e por isso tais variáveis devem ser métricas). 
Os fatores representam o comportamento conjunto das variáveis originais, e pode
ser visto como um agrupamento de variáveis.

O método de extração por componentes principais é o mais utilizado para análise
fatorial, este método extrai os fatores a partir das combinações lineares das
variáveis originais.


Esses fatores são ortogonais entre si, isto é, possui correlação 0 entre si, e 
são capazes de representar o comportamento conjunto das variáveis originais, e
pode ajudar na observação de comportamentos  que antes não eram possíveis de 
serem vistos, e portanto pode-se entender como um agrupamento de variáveis.

A análise fatorial por componentes principais tem três grandes usos:

>   1) Redução da dimensionalidade da base dados por meio do agrupamento de variáveis.
>   2) Confirmação de constructos pré determinados.
>   3) Elaboração de rankings por meio da criação de indicadores.

Sendo a elaboração de rankings uma de suas possibilidades é portanto por este
motivo que será utilizada a análise fatorial por componentes principais nesta 
base de dados, que tem por objetivo a criação de um ranking dos municípios do
Rio de Janeiro por meio de variáveis relacionadas à segurança pública.

# Ponderação arbitrária
Nesse momento faço voz para que não se confunda aqui uma variável quantitativa com 
uma qualitativa que seja expressada de forma numérica, como uma variável binária
que representa evento e não evento de algo, ou uma Escala deLikert. 
Tanto a variável binária de evento quanto a Escala de Likert são variáveis
que expressão categorias, logo não são numéricas, não é possível obter delas 
por exemplo, medidas de tendência central,dispersão ou correlação. 
E uma grande ressalva para a Escala de Likert, ainda que seja expressa em números, 
tal variável tem apenas valor semântico, e valor semântico não se mede, 
qual é a diferença numérica deruim para péssimo? Realizar uma análise fatorial
com tais variáveis resultaria em um problema de **Ponderação Arbitária**, onde 
se estará assumindo pesos numéricos para variáveis quali, onde por exemplo, se
estívéssemos falando de raça/cor, e dizemos que a cor branca é representada por
4 e a preta é 2, estamos dizendo com isso que a cor branca vale 2x mais que a 
preta, e podemos levar preconceito para nossa análise, por isso o cuidado ao
trabalhar com variáveis qualitativas.


# Apresentando a base de dados

Para este estudo os dados selecionados são referentes ao ano de 2020, e para cada
município do Rio de Janeiro se tem dados para cada mês. Para evitar um possível
mês com comportamento atípico, os dados mensais foram agregados e agora representam
apenas os dados de 2020, e cada linha é um muicípio.


Ao todo esta base, após filtragem e agregação, contém 92 observações e 54 variáveis, 
onde apenas a primeira, fmun_cod é qualitativa e representa o nome dos municípios
do Estado do Rio de Janeiro. As restantes variáveis são todas quantitativas e 
representam diferentes ocorrências de referentes à cada tipo de crime. 


```{r dados,eval = TRUE, echo = FALSE}


dados <- read.csv2("BaseMunicipioMensal.csv")
dados <- dados %>%
  filter(ano == 2020) %>%
  select(-fmun_cod,-ano, -mes,-mes_ano, -regiao, -fase)
dados <- aggregate(.~fmun, data = dados, FUN= sum)

dados %>%
  kable() %>%
  kable_styling(bootstrap_options = "striped",
                full_width = T,
                font_size = 12) %>% 
  kable_paper() %>%
  scroll_box(width ="900px", height = "400px")

```
# Análise fatorial por componentes principais
## Correlações
A matéria prima de uma análise  fatorial é uma matriz de correlações, que chamaremos
de rho. Um grande desafio ao se lidar com uma grande quantidade de variáveis 
quantitativas, e neste caso temos pouco mais de 50, é que uma análise bivariada
para cada par de variáveis se torna uma atividade difícil.

No entanto, um dos grandes usos de uma analise fatorial por componentes principais
é a redução da dimencionalidade da base de dados, e por isso essa quantidade de 
variáveis será mantidade
```{r correlacoes, eval = T, echo = F}
rho <- cor(dados[,2:54])
ggplotly(
rho %>% 
  melt() %>% 
  ggplot() +
  geom_tile(aes(x = Var1, y = Var2, fill = value)) +
  geom_text(aes(x = Var1, y = Var2, label = round(x = value, digits = 3)),
            size = 4) +
  labs(x = NULL,
       y = NULL,
       fill = "Correlações") +
  scale_fill_gradient2(low = "dodgerblue4", 
                       mid = "white", 
                       high = "brown4",
                       midpoint = 0) +
  theme(panel.background = element_rect("white"),
        panel.grid = element_line("grey95"),
        panel.border = element_rect(NA),
        legend.position = "bottom",
        axis.text.x = element_text(angle = 0))
)
```

https://www.geeksforgeeks.org/sum-of-rows-based-on-column-value-in-r-dataframe/
https://www.biostars.org/p/303219/
https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html
